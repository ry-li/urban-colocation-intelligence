<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2017 NAICS Interactive Hierarchy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .tree-line {
            position: absolute; left: 14px; top: 30px; bottom: 0; width: 1px; background-color: #e5e7eb; z-index: 0;
        }
        
        /* Indentation Logic based on data-level */
        .level-2 { border-left: 4px solid #2563eb; } /* Blue */
        .level-3 { border-left: 4px solid #0891b2; } /* Cyan */
        .level-4 { border-left: 4px solid #059669; } /* Green */
        .level-5 { border-left: 4px solid #d97706; } /* Amber */
        .level-6 { border-left: 4px solid #db2777; } /* Pink */
        
        .node-row:hover { background-color: #f3f4f6; }

        /* Animation for expand/collapse */
        .children-container { transition: all 0.3s ease-in-out; overflow: hidden; }
        .collapsed { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b p-4 z-10">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">NAICS Hierarchy Viewer</h1>
                <p class="text-sm text-gray-500">Source: r-li.com (via Proxy)</p>
            </div>
            
            <div class="flex gap-2 w-full md:w-auto">
                <input type="text" id="searchInput" placeholder="Search codes or titles..." 
                    class="border rounded px-3 py-2 text-sm w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="expandAll()" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded text-sm font-medium transition">Expand All</button>
                <button onclick="collapseAll()" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded text-sm font-medium transition">Collapse All</button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-4 relative" id="mainContainer">
        
        <!-- Loading / Error Overlay -->
        <div id="statusArea" class="max-w-2xl mx-auto mt-10 text-center bg-white p-8 rounded-xl shadow-lg border border-gray-200">
            <div class="mb-4">
                <svg class="w-16 h-16 mx-auto text-blue-500 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" id="spinner">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <div id="uploadIcon" class="hidden text-gray-400 mb-4">
                    <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                </div>
            </div>
            
            <h2 id="statusTitle" class="text-xl font-semibold mb-2">Connecting...</h2>
            
            <p id="statusMessage" class="text-gray-600 mb-6 text-sm">
                Trying to bypass browser security headers...
            </p>

            <!-- Fallback File Input -->
            <div id="manualUpload" class="hidden">
                <div class="p-6 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 hover:bg-blue-50 transition cursor-pointer relative" id="dropZone">
                    <input type="file" id="fileInput" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    <p class="text-sm text-gray-600 font-medium text-red-500 mb-2">Auto-Load Failed</p>
                    <p class="text-sm text-gray-600">We couldn't reach the file automatically.</p>
                    <p class="text-xs text-gray-500 mt-2">
                        1. Download <a href="https://r-li.com/urban-colocation-intelligence/naics/naisc-2017.csv" target="_blank" class="text-blue-600 underline">2017-NAICS.csv</a> manually.<br>
                        2. Drag & Drop the file here.
                    </p>
                </div>
            </div>
        </div>

        <!-- Tree Container (Hidden initially) -->
        <div id="treeRoot" class="max-w-5xl mx-auto space-y-2 hidden pb-20">
            <!-- Dynamic Content Goes Here -->
        </div>

    </main>

    <script>
        const TARGET_URL = 'https://r-li.com/urban-colocation-intelligence/naics/naisc-2017.csv';
        // Use a CORS proxy to bypass browser restriction
        const PROXY_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(TARGET_URL);

        let rawData = [];
        let treeData = [];

        // --- Initialization ---

        window.addEventListener('DOMContentLoaded', async () => {
            initLoad();
        });

        async function initLoad() {
            // 1. Try fetching via Proxy
            try {
                updateStatus("Trying CORS Proxy...", "Routing through allorigins.win");
                
                // Set a 5 second timeout so it doesn't get stuck
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(PROXY_URL, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error("Proxy failed");
                const text = await response.text();
                
                // Simple validation to ensure we got CSV, not an error HTML page
                if(!text.includes(',') && !text.includes('NAICS')) throw new Error("Invalid data");

                processCSV(text);
            } catch (err) {
                console.warn("Proxy load failed:", err);
                showManualUpload();
            }
        }

        function updateStatus(title, msg) {
            document.getElementById('statusTitle').innerText = title;
            document.getElementById('statusMessage').innerText = msg;
        }

        // --- Data Processing ---

        function showManualUpload() {
            document.getElementById('spinner').classList.add('hidden');
            document.getElementById('uploadIcon').classList.remove('hidden');
            document.getElementById('statusTitle').innerText = "Connection Failed";
            document.getElementById('statusMessage').innerHTML = `Browser security blocked external access.`;
            document.getElementById('manualUpload').classList.remove('hidden');

            // Setup listeners for manual input
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) readFile(file);
            });
        }

        function readFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => processCSV(e.target.result);
            reader.readAsText(file);
        }

        function processCSV(csvText) {
            document.getElementById('statusArea').classList.add('hidden');
            document.getElementById('treeRoot').classList.remove('hidden');

            // Parse CSV considering quotes
            rawData = parseCSVString(csvText);
            
            // Filter out header if it exists
            if (rawData.length > 0 && isNaN(parseInt(rawData[0].code))) {
                rawData.shift();
            }

            buildHierarchy();
            renderTree();
        }

        function parseCSVString(text) {
            const lines = text.split(/\r?\n/);
            const result = [];
            
            for (let line of lines) {
                if (!line.trim()) continue;
                const row = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') { inQuotes = !inQuotes; } 
                    else if (char === ',' && !inQuotes) { row.push(current.trim()); current = ''; } 
                    else { current += char; }
                }
                row.push(current.trim());
                if (row.length >= 2) {
                    result.push({ 
                        code: row[0].replace(/^"|"$/g, ''),
                        title: row[1].replace(/^"|"$/g, '') 
                    });
                }
            }
            return result;
        }

        function buildHierarchy() {
            rawData.sort((a, b) => a.code.localeCompare(b.code));
            const map = {};
            const roots = [];

            // 1. Create Nodes
            rawData.forEach(item => {
                map[item.code] = { ...item, children: [], level: item.code.length };
            });

            // 2. Link Parents
            rawData.forEach(item => {
                const node = map[item.code];
                const len = node.code.length;
                if (len > 2) {
                    const parentCode = node.code.substring(0, len - 1);
                    if (map[parentCode]) {
                        map[parentCode].children.push(node);
                    } else {
                        roots.push(node); // Orphan logic
                    }
                } else {
                    roots.push(node);
                }
            });
            treeData = roots.filter(n => n.level === 2 || !map[n.code.substring(0, n.code.length-1)]);
        }

        // --- Rendering ---

        const icons = {
            folder: `<svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>`,
            file: `<svg class="w-4 h-4 text-gray-300 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
            chevronRight: `<svg class="w-4 h-4 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`
        };

        function renderTree() {
            const container = document.getElementById('treeRoot');
            container.innerHTML = '';
            treeData.forEach(node => {
                container.appendChild(createNodeElement(node));
            });
        }

        function createNodeElement(node) {
            const branch = document.createElement('div');
            branch.className = 'w-full';
            branch.dataset.code = node.code;
            branch.dataset.title = node.title.toLowerCase();

            const row = document.createElement('div');
            const isLeaf = node.children.length === 0;
            const levelClass = `level-${node.level}`;
            const paddingLeft = (node.level - 2) * 1.5 + 1;

            row.className = `node-row flex items-center p-2 bg-white border-b border-gray-100 cursor-pointer transition select-none ${levelClass}`;
            row.style.paddingLeft = `${paddingLeft}rem`;
            
            const chevron = isLeaf ? '<span class="w-4 mr-2"></span>' : `<span class="chevron mr-2">${icons.chevronRight}</span>`;
            
            row.innerHTML = `
                ${chevron}
                <span class="font-mono text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded mr-3 font-bold min-w-[60px] text-center">${node.code}</span>
                <span class="text-sm ${node.level === 2 ? 'font-bold text-gray-800' : 'text-gray-700'}">${node.title}</span>
            `;

            branch.appendChild(row);

            if (!isLeaf) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'children-container collapsed border-l border-gray-200 ml-4';
                childrenContainer.style.marginLeft = `${(node.level - 2) * 1.5 + 1.2}rem`;
                node.children.forEach(child => childrenContainer.appendChild(createNodeElement(child)));
                branch.appendChild(childrenContainer);

                row.addEventListener('click', () => toggleNode(childrenContainer, row.querySelector('.chevron svg')));
            }
            return branch;
        }

        function toggleNode(container, chevronSvg) {
            const isHidden = container.classList.contains('collapsed');
            if (isHidden) {
                container.classList.remove('collapsed');
                if(chevronSvg) chevronSvg.classList.add('rotate-90');
            } else {
                container.classList.add('collapsed');
                if(chevronSvg) chevronSvg.classList.remove('rotate-90');
            }
        }

        // --- Search & Controls ---

        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            if (!term) { document.querySelectorAll('[data-code]').forEach(el => el.classList.remove('hidden')); return; }
            filterTree(term);
        });

        function filterTree(term) {
            const allBranches = document.querySelectorAll('#treeRoot [data-code]');
            allBranches.forEach(branch => {
                const matches = branch.dataset.code.includes(term) || branch.dataset.title.includes(term);
                if (matches) { branch.dataset.match = "true"; branch.classList.remove('hidden'); } 
                else { branch.dataset.match = "false"; branch.classList.add('hidden'); }
            });
            const matches = document.querySelectorAll('[data-match="true"]');
            matches.forEach(match => {
                let parent = match.parentElement;
                while(parent) {
                    if (parent.classList.contains('children-container')) {
                        parent.classList.remove('collapsed');
                        const prev = parent.previousElementSibling;
                        if(prev) { const chev = prev.querySelector('.chevron svg'); if(chev) chev.classList.add('rotate-90'); }
                        if(parent.parentElement) parent.parentElement.classList.remove('hidden');
                    }
                    if (parent.id === 'treeRoot') break;
                    parent = parent.parentElement;
                }
            });
        }

        function expandAll() {
            document.querySelectorAll('.children-container').forEach(el => el.classList.remove('collapsed'));
            document.querySelectorAll('.chevron svg').forEach(el => el.classList.add('rotate-90'));
        }

        function collapseAll() {
            document.querySelectorAll('.children-container').forEach(el => el.classList.add('collapsed'));
            document.querySelectorAll('.chevron svg').forEach(el => el.classList.remove('rotate-90'));
        }
    </script>
</body>
</html>